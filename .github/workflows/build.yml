name: Build Java Core Library

on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "master" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  test:
    runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v3
        - name: Setup Java
          uses: actions/setup-java@v3
          with:
            distribution: temurin
            java-version: 17
        - name: Setup Gradle
          uses: gradle/gradle-build-action@v2
          with:
            gradle-version: 8.4
        - name: Inject nexus credentials
          env:
            NEXUS_USER: ${{secrets.NEXUS_USER}}
            NEXUS_PASSWORD: ${{secrets.NEXUS_PASSWORD}}
          run: ./deploy/injectGradleCredentials.sh $NEXUS_USER $NEXUS_PASSWORD "gradle.properties"
        - name: Run tests
          run: ./gradlew unitTest jacocoUnitTestReport  integrationTest jacocoIntegrationTestReport --fail-fast

  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.4
      - name: Inject nexus credentials
        env:
          NEXUS_USER: ${{secrets.NEXUS_USER}}
          NEXUS_PASSWORD: ${{secrets.NEXUS_PASSWORD}}
        run: ./deploy/injectGradleCredentials.sh $NEXUS_USER $NEXUS_PASSWORD "gradle.properties"
      - name: Run build with Gradle Wrapper
        run: ./gradlew build -x test

  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.4
      - name: Run build with Gradle Wrapper
        run: ./gradlew build -x test
